<?php
if(!in_array($today, $yearsSchedule['dayoff'])) {
	// Í≥ÑÏ†àÌïôÍ∏∞ Ï†ÑÏ≤¥Í∏∞Í∞Ñ
	$termOfSeason = (($today >= $semesterW['start'] && $today <= $semesterW['end']) || ($today >= $semesterS['start'] && $today <= $semesterS['end']));
	// Ï†ïÍ∑úÌïôÍ∏∞ Ï†ÑÏ≤¥Í∏∞Í∞Ñ
	$termOfRegular = (($today >= $semester1['start'] && $today <= $semester1['end']) || ($today >= $semester2['start'] && $today <= $semester2['end']));
	// Ï†ïÍ∑úÌïôÍ∏∞ ((Í∞úÍ∞ïÏùº ~ Ï§ëÍ∞ÑÍ≥†ÏÇ¨ ÏãúÏûëÏùº) && (Ï§ëÍ∞ÑÍ≥†ÏÇ¨ Ï¢ÖÎ£åÏùº ~ Í∏∞ÎßêÍ≥†ÏÇ¨ ÏãúÏûëÏùº))
	$termOfRegularFromStartToEnd = ((($today >= $semester1['start'] && $today < $semester1['term']['mid']['start']) || ($today > $semester1['term']['mid']['end'] && $today < $semester1['term']['final']['start'])) || (($today >= $semester2['start'] && $today < $semester2['term']['mid']['start']) || ($today > $semester2['term']['mid']['end'] && $today < $semester2['term']['final']['start'])));
	
	if($termOfSeason || ($termOfRegular && $termOfRegularFromStartToEnd)) {
		///////////////////////////////////////////////////////////////////////////////// Ï∂úÏ≤µ ÏïåÎ¶º //////////////////////////////////////////////////////////////////////////////////////
		//
		// Ï≤´ ÏùëÎãµ(5Î∂Ñ) ÌõÑ, 5Î∂ÑÎïåÏóê (NOTYET)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨ÎûåÎì§ÏóêÍ≤å 10Î∂Ñ Îí§ Îã§Ïãú Î¨ºÏñ¥Î¥Ñ
		// ÎëêÎ≤àÏß∏ ÏùëÎãµ(10Î∂Ñ) ÌõÑ, 15Î∂Ñ Îí§ Î™®Îì† ÏÇ¨ÎûåÎì§ÏóêÍ≤å Í≤∞Í≥ºÎßå ÏïåÎ†§Ï§å
		//

		for($i=0; $i<count($userInfo); $i++) {
			// Ïù¥Î≤§Ìä∏ Î™©Î°ùÏóêÏÑú Ìú¥Í∞ïÏúºÎ°ú Îì±Î°ùÌïú Î™©Î°ùÏù¥ ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
			$query = "SELECT * FROM event WHERE userkey='".$userInfo[$i]['userkey']."' AND year='$thisYear' AND semester='$thisSemester' AND type='cancel' AND title='".$userInfo[$i]['title']."'";
			$sql4event = $conn->query($query);
			while($row4event = $sql4event->fetch_assoc()) {
				$eventCancel[] = $row4event;
			}
			if(!empty($eventCancel)) {
				for($e=0; $e<count($eventCancel); $e++) {
					$eventCancel1 = date("Y-m-d", mktime(0,0,0, substr($eventCancel[$e]['date1'],0,2), substr($eventCancel[$e]['date1'],2,4), date("Y")));
					if($eventCancel[$e]['date2']) {
						$eventCancel2 = date("Y-m-d", mktime(0,0,0, substr($eventCancel[$e]['date2'],0,2), substr($eventCancel[$e]['date2'],2,4), date("Y")));
						if($today >= $eventCancel1 && $today <= $eventCancel2) {
							$eventCancelResult[] = FALSE;
						} else {
							$eventCancelResult[] = TRUE;
						}
					} else {
						if($today == $eventCancel1) {
							$eventCancelResult[] = FALSE;
						} else {
							$eventCancelResult[] = TRUE;
						}
					}
				}				
			} else {
				$eventCancelResult[] = TRUE;
			}

			if(in_array(FALSE, $eventCancelResult)) {
				continue;
			} else {
				$daily = array('Ïùº', 'Ïõî', 'Ìôî', 'Ïàò', 'Î™©', 'Í∏à', 'ÌÜ†');
				$numOfDays = count($daily)-1;
				$date = date('w');
				$todayDaily = $daily[$date];
				
				for($j=1; $j<=$numOfDays; $j++) {
					${startTime.$j} = strtotime($userInfo[$i]['time'.$j]);
					${endTime.$j} = strtotime($userInfo[$i]['time'.$j]) + ($userInfo[$i]['min'.$j]*60);
					$after5minFromStart = ${startTime.$j}+5*60;
					$after10minFromStart = ${startTime.$j}+10*60;
					$after15minFromStart = ${startTime.$j}+15*60;
					//$end = ${endTime.$j};
					//$after5minFromEnd = ${endTime.$j}+5*60;
					
					// Í∞ôÏùÄ ÏöîÏùºÏùò ÎÇ†Ïßú Ï§ë,
					if($userInfo[$i]['day'.$j] == $todayDaily) {
						$textAttendanceArr = array("Ï∂úÏ≤µÌï®?", "Ï∂úÏ≤µÌñàÎÇò?", "Ï∂úÏ≤µÌñàÎÇ≠", "Ï∂úÏ≤µÌñàÏñ¥..?", "Ï∂úÏ≤µÌï¥Ïç®?", "Ï∂úÏ≤µÌñàÎãà..?", "Ï∂úÏ≤µÌñàÏñ¥?", "Ï∂úÏ≤µÌï¥ÏîÄ?");
						shuffle($textAttendanceArr);
						$textYesArr = array("„Öá„Öá", "„Öá„ÖáÌñàÏùå", "Ìï®„Öã„Öã", "„Öá„ÖáÌï®", "ÌñàÎã§„Öã„Öã", "ÌñàÏùå„Öã„Öã", "ÌñàÏßÄ„Öã„Öã", "Ìï® „ÖÇ2", "Ìï¥ÏîÄ„Öã„Öã", "ÎãπÏó∞", "„Öã„ÖãÎπ†Ïóº");
						shuffle($textYesArr);
						$textNotYetArr = array("„Ñ¥„Ñ¥ÏïÑÏßÅ", "ÏïÑÏßÅ„Ñ¥„Ñ¥", "ÏïÑÏßÅ ÏïàÌï®„Öã„Öã", "„Ñ¥„Ñ¥ÏïÑÏßÅÏù∏ÎìØ?", "ÏïÑÏßÅ ÏïàÌï¥Ïç®");
						shuffle($textNotYetArr);
						$textNoArr = array("„Ñ¥„Ñ¥", "„Ñ¥„Ñ¥ÏïàÌï®", "„Ñ¥„Ñ¥ÏïàÌï¥ÏîÄ", "ÏïàÌï¥ÏîÄ", "ÏïàÌï®", "ÏïàÌï®„Öã„Öã", "ÏïàÌï¥ÏîÄ„Öã„Öã", "ÏïàÌñàÏùå„Öã„Öã", "ÏïàÌï¥Îî∞„Öã„Öã", "ÏïàÌñàÏùå", "ÏïàÌï®Ïöî");
						shuffle($textNoArr);
						//$textIdontknowArr = array("Î©ÄÎùº?", "ÎÇòÎèÑ Î™∞Îùº„Öã„Öã", "ÎÇòÎèÑÎ™∞Îùº?", "ÎÇòÎèÑ Î™®Î¶Ñ„Öã„Öã", "Î©ÄÎùº„Öã„Öã");
						//shuffle($textIdontknowArr);
						
						// 5Î∂Ñ ÌõÑ, Ï∂úÏ≤µ Ïó¨Î∂Ä ÌôïÏù∏ Ìë∏Ïãú Ï†ÑÏÜ°
						if(date("Y-m-d H:i", $now) == date("Y-m-d H:i", $after5minFromStart)) {
							$query = "INSERT INTO attendance (userkey, year, semester, title, class, prof, classroom, day, time, inputTime)
																		VALUE ('{$userInfo[$i]['userkey']}', '$thisYear', '$thisSemester', '{$userInfo[$i]['title']}',
																						'{$userInfo[$i]['class']}', '{$userInfo[$i]['prof']}', '{$userInfo[$i]['classroom'.$j]}',
																						'{$todayDaily}', '{$userInfo[$i]['time'.$j]}', '$inputTime')";
							$conn->query($query);
			
							$send['title'] = array("üé©: " . $userInfo[$i]['title'] . " " . $textAttendanceArr[0]);
							$send['imgUrl'] = "https://bhandy.kr/scheduler/univ/pnu/webview/attendance/attendance.jpg";
							$send['buttonsTitle'] = array('‚≠ï'.$textYesArr[0], '‚úã'.$textNotYetArr[0]); // '‚ùì'.$textIdontknowArr[0]
							$webviewBaseUrl = "https://bhandy.kr/scheduler/univ/pnu/webview/attendance/";
							$send['buttonsUrl'] = array($webviewBaseUrl.'attendanceYes.php', $webviewBaseUrl.'attendanceNotyet.php');	
							messageAttendance($send, $userInfo[$i]['userkey'], 'UPDATE');
							
							/*
							$send['text'] = "üé©: " . $userInfo[$i]['title'] . " " . $textAttendanceArr[0];
							$send['title'] = array('‚≠ï'.$textYesArr[0], '‚úã'.$textNotYetArr[0], '‚ùì'.$textIdontknowArr[0]);
					
							$payloadInfos = $userInfo[$i]['title'] . "_" . $userInfo[$i]['class'] . "_" . $userInfo[$i]['prof'] . "_" . $todayDaily . "_" . $userInfo[$i]['time'.$j];
							$send['payload'] = array("Attendance_YES_".$payloadInfos, "Attendance_NOTYET_".$payloadInfos, "Attendance_IDONTKNOW_".$payloadInfos);
					
							messageQR($send, $userInfo[$i]['userkey'], 'UPDATE');
							*/
						}
						// Ï≤´ ÏùëÎãµ(5Î∂Ñ) ÌõÑ, 5Î∂Ñ Îí§Ïóê (NOTYET)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨ÎûåÎì§ÏóêÍ≤å 10Î∂Ñ Îí§ Îã§Ïãú Î¨ºÏñ¥Î¥Ñ
						else if(date("Y-m-d H:i", $now) == date("Y-m-d H:i", $after10minFromStart)) {
							$query = "SELECT DISTINCT userkey FROM user WHERE year='$thisYear' AND semester='$thisSemester' AND userkey IN
												(
													SELECT userkey FROM attendance WHERE (attend='NOTYET' OR attend IS NULL)
														AND UNIX_TIMESTAMP(inputTime) >= ". ($now-5*60) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
												)";
							$sql4attendance = $conn->query($query);
							$attendanceUserkeys = array();
							while($row4attendance = $sql4attendance->fetch_assoc()) {
								$attendanceUserkeys[] = $row4attendance['userkey'];		//  (YES)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨ÎûåÏùÑ Ï†úÏô∏Ìïú Î™®Îëê
							}
							
							if(!in_array($userInfo[$i]['userkey'], $attendanceUserkeys)) {
								continue;
							} else {
								$send['title'] = array("üé©: " . $userInfo[$i]['title'] . " " . $textAttendanceArr[0]);
								$send['imgUrl'] = "https://bhandy.kr/scheduler/univ/pnu/webview/attendance/attendance.jpg";
								$send['buttonsTitle'] = array('‚≠ï'.$textYesArr[0],  '‚ùå'.$textNoArr[0]);
								$webviewBaseUrl = "https://bhandy.kr/scheduler/univ/pnu/webview/attendance/";
								$send['buttonsUrl'] = array($webviewBaseUrl.'attendanceYes.php', $webviewBaseUrl.'attendanceNo.php');	
								messageAttendance($send, $userInfo[$i]['userkey'], 'UPDATE');
							}
							
							/*
							$query = "SELECT DISTINCT userkey FROM user WHERE year='$thisYear' AND semester='$thisSemester' AND userkey IN
												(
													SELECT userkey FROM attendance WHERE attend='NOTYET'
														AND UNIX_TIMESTAMP(inputTime) >= ". ($now-5*60) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
												)";
							$sql4attendance = $conn->query($query);
							$attendanceUserkeys = array();
							while($row4attendance = $sql4attendance->fetch_assoc()) {
								$attendanceUserkeys[] = $row4attendance['userkey'];		//  (NOTYET)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨Îûå Î™®Îëê
							}
							
							if(!in_array($userInfo[$i]['userkey'], $attendanceUserkeys)) {
								continue;
							} else {
								$send['text'] = "üé©: " . $userInfo[$i]['title'] . " " . $textAttendanceArr[0];
								$send['title'] = array('‚≠ï'.$textYesArr[0], '‚úã'.$textNotYetArr[0], '‚ùì'.$textIdontknowArr[0]);
						
								$payloadInfos = $userInfo[$i]['title'] . "_" . $userInfo[$i]['class'] . "_" . $userInfo[$i]['prof'] . "_" . $todayDaily . "_" . $userInfo[$i]['time'.$j];
								$send['payload'] = array("Attendance_YES_".$payloadInfos, "Attendance_NOTYET_".$payloadInfos, "Attendance_IDONTKNOW_".$payloadInfos);
								
								messageQR($send, $userInfo[$i]['userkey'], 'UPDATE');
							}
							*/ 
						}
						// ÎëêÎ≤àÏß∏ ÏùëÎãµ(10Î∂Ñ) ÌõÑ, 15Î∂Ñ Îí§Ïóê Î™®Îì† ÏÇ¨ÎûåÎì§ÏóêÍ≤å Í≤∞Í≥ºÎßå ÏïåÎ†§Ï§å
						else if(date("Y-m-d H:i", $now) == date("Y-m-d H:i", $after15minFromStart)) {
							// Í∞ôÏùÄ ÏàòÏóÖ Îì£Îäî ÏÇ¨ÎûåÎì§Ïùò Ï¥ù Ïù∏Ïõê Ïàò
							$query = "SELECT DISTINCT userkey FROM user WHERE year='$thisYear' AND semester='$thisSemester'
																							AND title='{$userInfo[$i]['title']}' AND class='{$userInfo[$i]['class']}'
																							AND prof='{$userInfo[$i]['prof']}' AND day" . $j . "='{$todayDaily}' AND time" . $j . "='{$userInfo[$i]['time'.$j]}'";
							$sql4user = $conn->query($query);
							$wholeUserkeys = array();
							while($row4user = $sql4user->fetch_assoc()) {
								$wholeUserkeys[] = $row4user['userkey'];
							}	
							$numOfUserkeys = count($wholeUserkeys);

							// YES ÎùºÍ≥† ÎãµÌïú ÏÇ¨ÎûåÎì§ Ïàò
							$query = "SELECT DISTINCT userkey FROM user WHERE year='$thisYear' AND semester='$thisSemester'
																												AND title='{$userInfo[$i]['title']}' AND class='{$userInfo[$i]['class']}'
																												AND prof='{$userInfo[$i]['prof']}' AND day" . $j . "='{$todayDaily}' AND time" . $j . "='{$userInfo[$i]['time'.$j]}'
																												AND userkey IN
																												(
																													SELECT userkey FROM attendance WHERE attend='YES'
																														AND UNIX_TIMESTAMP(inputTime) >= ". ($now-10*60) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
																												)";
							$sql4attendanceYes = $conn->query($query);
							$attendanceYesUserkeys = array();
							while($row4attendanceYes = $sql4attendanceYes->fetch_assoc()) {
								$attendanceYesUserkeys[] = $row4attendanceYes['userkey'];		//  (YES)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨Îûå
							}
							$numOfAttendanceYes = count($attendanceYesUserkeys);
							
							// NO ÎùºÍ≥† ÎãµÌïú ÏÇ¨ÎûåÎì§ Ïàò
							$query = "SELECT DISTINCT userkey FROM user WHERE year='$thisYear' AND semester='$thisSemester'
																												AND title='{$userInfo[$i]['title']}' AND class='{$userInfo[$i]['class']}'
																												AND prof='{$userInfo[$i]['prof']}' AND day" . $j . "='{$todayDaily}' AND time" . $j . "='{$userInfo[$i]['time'.$j]}'
																												AND userkey IN
																												(
																													SELECT userkey FROM attendance WHERE attend='NO'
																														AND UNIX_TIMESTAMP(inputTime) >= ". ($now-10*60) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
																												)";
							$sql4attendanceNo = $conn->query($query);
							$attendanceNoUserkeys = array();
							while($row4attendanceNo = $sql4attendanceNo->fetch_assoc()) {
								$attendanceNoUserkeys[] = $row4attendanceNo['userkey'];		//  (YES)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨Îûå
							}
							$numOfAttendanceNo = count($attendanceNoUserkeys);
							
							if($numOfAttendanceYes != 0) {
								$send['text'] = "üé©: Ïò§Îäò " . $userInfo[$i]['title'] . " Îì£Îäî " . $numOfUserkeys . "Î™Ö Ï§ëÏóê " . $numOfAttendanceYes . "Î™ÖÏù¥ [Ï∂úÏ≤µÌñàÎã§]Î•º,\nÍ∑∏Î¶¨Í≥† " . $numOfAttendanceNo . "Î™ÖÏù¥ [Ï∂úÏ≤µÏïàÌñàÎã§]Î•º ÏÑ†ÌÉùÌñàÏäµÎãàÎã§.üëç";
								$send['payload'] = $send['title'] = array('Ï¥àÍ∏∞ÌôîÎ©¥');
								messageQR($send, $userInfo[$i]['userkey'], 'UPDATE');
							} else {
								// Ìú¥Í∞ïÏù∏ÏßÄ Ï≤¥ÌÅ¨Ìï¥Î≥¥ÎèÑÎ°ù Ïú†ÎèÑ
								$query = "INSERT INTO logging (userkey, year, semester, inProgress, inputTime) VALUE ('{$userInfo[$i]['userkey']}', '$thisYear', '$thisSemester', 'READ', '$inputTime')";
								$conn->query($query);
								$query = "INSERT INTO loggingRead (userkey, year, semester, inProgress, type, title, class, prof, inputTime)
																				VALUE ('{$userInfo[$i]['userkey']}', '$thisYear', '$thisSemester', 'READ_EVENT',
																								'cancel', '{$userInfo[$i]['title']}', '{$userInfo[$i]['class']}', '{$userInfo[$i]['prof']}', '$inputTime'
																							)";
								$conn->query($query);
			
								$send['text'] = "üé©: " . $userInfo[$i]['title'] . " Îì£Îäî " . $numOfUserkeys . "Î™Ö Ï§ëÏóê [Ï∂úÏ≤µÌñàÎã§]Î•º ÏÑ†ÌÉùÌïú ÏÇ¨ÎûåÏù¥ ÏóÜÏñ¥Ïöî..üí¶\nÎã§Î•∏ ÏÇ¨ÎûåÎì§Ïù¥ Ìú¥Í∞ïÏù¥ÎùºÍ≥† Îì±Î°ùÌóÄÎäîÏßÄ ÌôïÏù∏Ìï¥Î≥ºÎûòÏöî?üò∂";
								$send['title'] = array("Îã§Î•∏ ÏÇ¨Îûå Ìú¥Í∞ï Ï†ïÎ≥¥ Î≥¥Í∏∞", 'Ï¥àÍ∏∞ÌôîÎ©¥');
								$send['payload'] = array("OTHERS_cancel_{$userInfo[$i]['title']}_{$userInfo[$i]['class']}_{$userInfo[$i]['prof']}", 'Ï¥àÍ∏∞ÌôîÎ©¥');
								messageQR($send, $userInfo[$i]['userkey'], 'UPDATE');
							}
						}
						unset($send);
							/*
							// IDONTKNOW ÎùºÍ≥† ÎãµÌïú ÏÇ¨ÎûåÎì§ Ïàò
							$query = "SELECT DISTINCT userkey FROM user WHERE year='$thisYear' AND semester='$thisSemester'
																												AND title='{$userInfo[$i]['title']}' AND class='{$userInfo[$i]['class']}'
																												AND prof='{$userInfo[$i]['prof']}' AND day" . $j . "='{$todayDaily}' AND time" . $j . "='{$userInfo[$i]['time'.$j]}'
																												AND userkey IN
																												(
																													SELECT userkey FROM attendance WHERE attend='IDONTKNOW'
																														AND UNIX_TIMESTAMP(inputTime) >= ". ($now-10*60) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
																												)";
							$sql4attendanceIdontknow = $conn->query($query);
							$attendanceIdontknowUserkeys = array();
							while($row4attendanceIdontknow = $sql4attendanceIdontknow->fetch_assoc()) {
								$attendanceIdontknowUserkeys[] = $row4attendanceIdontknow['userkey'];		//  (IDONTKNOW)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨Îûå
							}
							$numOfAttendanceIdontknow = count($attendanceIdontknowUserkeys);
							
							if($numOfAttendanceYes != 0) {
								$send['text'] = "üé©: " . $userInfo[$i]['title'] . " Îì£Îäî " . $numOfUserkeys . "Î™Ö Ï§ëÏóê " . $numOfAttendanceYes . "Î™ÖÏù¥ Ï∂úÏ≤µÌñàÎã§Ïπ¥ÎäîÎç∞?";
								$send['payload'] = $send['title'] = array('Ï¥àÍ∏∞ÌôîÎ©¥');
								messageQR($send, $userInfo[$i]['userkey'], 'UPDATE');
							} else {
								// Ìú¥Í∞ïÏù∏ÏßÄ Ï≤¥ÌÅ¨Ìï¥Î≥¥ÎèÑÎ°ù Ïú†ÎèÑ
								$query = "INSERT INTO logging (userkey, year, semester, inProgress, inputTime) VALUE ('{$userInfo[$i]['userkey']}', '$thisYear', '$thisSemester', 'READ', '$inputTime')";
								$conn->query($query);
								$query = "INSERT INTO loggingRead (userkey, year, semester, inProgress, type, title, class, prof, inputTime)
																				VALUE ('{$userInfo[$i]['userkey']}', '$thisYear', '$thisSemester', 'READ_EVENT',
																								'cancel', '{$userInfo[$i]['title']}', '{$userInfo[$i]['class']}', '{$userInfo[$i]['prof']}', '$inputTime'
																							)";
								$conn->query($query);

								$send['text'] = "üé©: " . $userInfo[$i]['title'] . " Îì£Îäî " . $numOfUserkeys . "Î™Ö Ï§ëÏóê Ï∂úÏ≤µÌñàÎã§Ïπ¥Îäî ÏÇ¨ÎûåÏù¥ ÏóÜÎäîÎç∞..\nÎã§Î•∏ ÏÇ¨ÎûåÎì§Ïù¥ Ìú¥Í∞ïÏù¥ÎùºÍ≥† Îì±Î°ùÌóÄÎäîÏßÄ ÌôïÏù∏Ìï¥Î≥ºÎûò?";
								$send['title'] = array("Îã§Î•∏ ÏÇ¨Îûå Ìú¥Í∞ï Ï†ïÎ≥¥ Î≥¥Í∏∞", 'Ï¥àÍ∏∞ÌôîÎ©¥');
								$send['payload'] = array("OTHERS_cancel_{$userInfo[$i]['title']}_{$userInfo[$i]['class']}_{$userInfo[$i]['prof']}", 'Ï¥àÍ∏∞ÌôîÎ©¥');
								messageQR($send, $userInfo[$i]['userkey'], 'UPDATE');
							 	*/
							 	
							 	
							 	
						/*
						// ÏàòÏóÖ ÎßàÏ≥§ÏùÑ Îïå, (NOT YET)Ïù¥ÎùºÍ≥† ÎãµÌïú ÏÇ¨ÎûåÎì§ÏóêÍ≤å Î¨ºÏñ¥Î¥Ñ
						else if($now == $end) {
							$query = "SELECT userkey FROM user WHERE userkey IN
												(
													SELECT userkey FROM attendance WHERE attend='NOTYET'
														AND UNIX_TIMESTAMP(inputTime) >= ". ($now-$userInfo[$i]['min'.$j]*60) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
												)";
							$sql4attendance = $conn->query($query);
							while($row4attendance = $sql4attendance->fetch_assoc()) {
								$attendanceUserkeys[] = $row4attendance['userkey'];		//  (NOTYET)ÏùÑ ÏÑ†ÌÉùÌïú ÏÇ¨Îûå Î™®Îëê
							}
							
							if(!in_array($userInfo[$i]['userkey'], $attendanceUserkeys)) {
								continue;
							} else {
								$send['text'] = "üé©: " . $userInfo[$i]['title'] . " " . $textAttendanceArr[0];
								$send['title'] = array('‚≠ï'.$textYesArr[0], '‚ùå'.$textNoArr[0]);
						
								$payloadInfos = $userInfo[$i]['title'] . "_" . $userInfo[$i]['class'] . "_" . $userInfo[$i]['prof'] . "_" . $todayDaily . "_" . $userInfo[$i]['time'.$j];
								$send['payload'] = array("Attendance_YES_".$payloadInfos, "Attendance_NO_".$payloadInfos);
								
								messageQR($send, $userInfo[$i]['userkey']);					
							}		
						}
						// ÏàòÏóÖ ÎßàÏπòÍ≥† 5Î∂Ñ ÌõÑ, (IDONTKNOW || ÏùëÎãµX)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨ÎûåÎì§ÏóêÍ≤å Í≤∞Í≥ºÎ•º ÏïåÎ†§Ï§å
						else if($now == $after5minFromEnd) {
							$query = "SELECT userkey FROM user WHERE userkey NOT IN 
												(
													SELECT userkey FROM attendance WHERE attend='YES' OR attend='NOTYET'
														AND UNIX_TIMESTAMP(inputTime) >= ". ($now-$userInfo[$i]['min'.$j]*60 ) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
												)";
							$sql4attendance = $conn->query($query);
							while($row4attendance = $sql4attendance->fetch_assoc()) {
								$attendanceUserkeys[] = $row4attendance['userkey'];		//  (YES or NOTYET)ÏùÑ ÏÑ†ÌÉùÌïú ÏÇ¨ÎûåÏùÑ Ï†úÏô∏Ìïú Î™®Îëê
							}
							
							if(!in_array($userInfo[$i]['userkey'], $attendanceUserkeys)) {
								continue;
							} else {
								// Í∞ôÏùÄ ÏàòÏóÖ Îì£Îäî ÏÇ¨ÎûåÎì§Ïùò Ï¥ù Ïù∏Ïõê Ïàò
								$query = "SELECT * FROM user WHERE title='{$userInfo[$i]['title']}' AND class='{$userInfo[$i]['class']}'
																						AND prof='{$userInfo[$i]['prof']}' AND day" . $j . "='{$todayDaily}' AND time" . $j . "='{$userInfo[$i]['time'.$j]}'";
								$sql4user = $conn->query($query);
								while($row4user = $sql4user->fetch_assoc()) {
									$wholeUserkeys[] = $row4user;
								}	
								$numOfUserkeys = count($wholeUserkeys);
								
								// YES ÎùºÍ≥† ÎãµÌïú ÏÇ¨ÎûåÎì§ Ïàò
								$query = "SELECT * FROM user WHERE title='{$userInfo[$i]['title']}' AND class='{$userInfo[$i]['class']}'
																						AND prof='{$userInfo[$i]['prof']}' AND day" . $j . "='{$todayDaily}' AND time" . $j . "='{$userInfo[$i]['time'.$j]}'
																						AND userkey IN
																						(
																							SELECT userkey FROM attendance WHERE attend='YES'
																								AND UNIX_TIMESTAMP(inputTime) >= ". ($now-$userInfo[$i]['min'.$j]*60) . " AND UNIX_TIMESTAMP(inputTime) <= " . $now . "
																						)";
								$sql4attendanceYes = $conn->query($query);
								while($row4attendanceYes = $sql4attendanceYes->fetch_assoc()) {
									$attendanceYesUserkeys[] = $row4attendanceYes;		//  (YES)Î•º ÏÑ†ÌÉùÌïú ÏÇ¨Îûå Î™®Îëê
								}
								$numOfAttendanceYes = count($attendanceYesUserkeys);
								
								if($numOfAttendanceYes != 0) {
									$send['text'] = "üé©: " . $userInfo[$i]['title'] . " Îì£Îäî ÏÇ¨ÎûåÏù¥ " . $numOfUserkeys . "Î™Ö Ïù∏Îç∞,\nÍ∑∏ Ï§ëÏóê" . $numOfAttendanceYes . "Î™ÖÏù¥ Ï∂úÏ≤µÌñàÎã§Ïπ¥ÎäîÎç∞?";
									$send['payload'] = $send['title'] = array('Ï¥àÍ∏∞ÌôîÎ©¥');
									messageQR($send, $userInfo[$i]['userkey']);						
								} else {
									// Ìú¥Í∞ïÏù∏ÏßÄ Ï≤¥ÌÅ¨Ìï¥Î≥¥ÎèÑÎ°ù Ïú†ÎèÑ
									$query = "INSERT INTO logging (userkey, inProgress, inputTime) VALUE ('{$userInfo[$i]['userkey']}', 'READ_EVENT', '$inputTime')";
									$conn->query($query);
									$query = "INSERT INTO loggingRead (userkey, inProgress, title, inputTime) VALUE ('{$userInfo[$i]['userkey']}', 'READ_EVENT', '{$userInfo[$i]['title']}', '$inputTime')";
									$conn->query($query);
									
									$send['text'] = "üé©: " . $userInfo[$i]['title'] . " Îì£Îäî ÏÇ¨ÎûåÎì§ Ï§ëÏóê Ï∂úÏ≤µÌñàÎã§Ïπ¥Îäî ÏÇ¨ÎûåÏù¥ ÏóÜÎäîÎç∞..\nÎã§Î•∏ ÏÇ¨ÎûåÎì§Ïù¥ Ìú¥Í∞ïÏù¥ÎùºÍ≥† ÌñàÎäîÏßÄ ÌôïÏù∏Ìï¥Î≥ºÎûò?";
									$send['payload'] = array('attendance_'.$userInfo[$i]['title'] ,'Ï¥àÍ∏∞ÌôîÎ©¥');
									$send['title'] = array($userInfo[$i]['title'].' Ìú¥Í∞ïÏù∏ÏßÄ ÌôïÏù∏ÌïòÍ∏∞', 'Ï¥àÍ∏∞ÌôîÎ©¥');
									messageQR($send, $userInfo[$i]['userkey']);
								}
							}				
						}*/
					}
				}
			}	
		}		
	}
}

// ÎßåÏïΩ 3Î≤à ÏàòÏóÖ Ïó∞ÏÜç "Ï∂úÏ≤µÏùÑ ÏïàÌñàÎã§"Î•º 
